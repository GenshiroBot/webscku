<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenshiroBot</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Three.js for 3D Background Animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Custom Tailwind Configuration (Deep Core Aesthetic) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'core-dark': '#060B12',      // Extremely dark background
                        'primary-accent': '#4F46E5', // Deep Indigo/Violet (Smooth, heavy accent)
                        'secondary-accent': '#10B981', // Emerald Green (Success, action)
                        'text-light': '#E5E7EB',     // Near-white text
                        'glass-bg': 'rgba(17, 24, 39, 0.85)', // Darker, heavier slate for glass
                        'error-red': '#F87171',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Roboto Mono', 'monospace'],
                    },
                    boxShadow: {
                        // Deep shadow, NO neon glow component
                        'depth': '0 15px 40px rgba(0, 0, 0, 0.9), 0 0 5px rgba(79, 70, 229, 0.2) inset', 
                        'btn-depth': '0 4px 10px rgba(0, 0, 0, 0.5)',
                    },
                    transitionTimingFunction: {
                        'smooth-curve': 'cubic-bezier(0.4, 0.0, 0.2, 1)', // Standard smooth curve
                    },
                    animation: {
                        'pulse-subtle': 'pulse-subtle 8s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'data-stream': 'data-stream 1.5s ease-in-out infinite',
                    },
                    keyframes: {
                        'pulse-subtle': {
                            '0%, 100%': { transform: 'scale(1.0)', opacity: '1' },
                            '50%': { transform: 'scale(1.002)', opacity: '0.99' },
                        },
                        'data-stream': {
                            '0%, 100%': { opacity: '0.4' },
                            '50%': { opacity: '1.0' },
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Base styles for the dark, futuristic environment */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        
        body {
            background: #060B12; 
            color: #E5E7EB; 
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Inter', sans-serif;
            padding: 1rem;
            overflow-x: hidden;
        }
        
        /* Three.js Canvas Styling for Full-Screen Background */
        #threeCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; 
            opacity: 0.6; /* Less distracting */
        }

        /* Glassmorphism Container (Deep Core Style) */
        .glass-container {
            background-color: var(--tw-colors-glass-bg); 
            backdrop-filter: blur(20px); /* Smoother blur */
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px; 
            border: 1px solid rgba(79, 70, 229, 0.2); /* Subtle Indigo border */
            box-shadow: var(--tw-shadow-depth); 
            max-width: 95%;
            width: 100%;
            margin: auto;
            overflow: hidden;
            transition: all 0.5s var(--tw-transition-timing-function-smooth-curve); 
            z-index: 10; 
            position: relative; 
            animation: pulse-subtle 8s infinite; 
        }
        
        /* Primary Accent Button Style */
        .accent-btn {
            background-color: #4F46E5; 
            color: #E5E7EB; /* Text light */
            padding: 0.9rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            letter-spacing: 0.05em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--tw-shadow-btn-depth);
        }

        .accent-btn:hover {
            transform: translateY(-2px);
            background-color: #10B981; /* Emerald on hover */
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3);
        }
        
        /* Input Field Styling */
        .glass-input {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(79, 70, 229, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Roboto Mono', monospace;
        }

        .glass-input:focus {
            outline: none;
            border-color: #10B981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        /* Loading Spinner - Deep contrast */
        .spinner {
            border: 6px solid rgba(255, 255, 255, 0.1);
            border-top-color: #4F46E5;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 0.8s linear infinite; 
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <!-- Firebase SDKs, Core Logic, and Three.js -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, where, getDocs, runTransaction, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // --- GLOBAL CONSTANTS & STATE ---
        const ADMIN_KEY = "Dimas123@@"; 
        
        // --- MAP DYNAMIC SCRIPTS HERE ---
        const SCRIPT_MAP = [
            { id: 'base', name: 'GenshiroBot SimpleBase', url: 'https://files.catbox.moe/pl8mo7.html' },
            { id: 'bot-telegram-v2', name: 'Bot Telegram Management V2', url: 'https://github.com/scripts/telegram_bot_v2.zip' },
            { id: 'autoreply-ig', name: 'AutoReply Instagram DM', url: 'https://myserver.com/autoreply_ig.rar' },
            { id: 'rest-api-v1', name: 'REST API Toolkit V1 (Premium)', url: 'https://cdn.private.com/api_toolkit.zip' },
        ];
        // --------------------------------

        window.db = null;
        window.auth = null;
        window.userId = null;
        window.currentView = 'landingView';
        window.userTokenData = null; 
        window.isAuthReady = false;
        window.hasDownloaded = false; 

        window.getScriptDetails = (scriptId) => SCRIPT_MAP.find(s => s.id === scriptId) || { id: 'error', name: 'Script Tidak Ditemukan', url: '#' };

        // Helper to construct Firestore paths (Public for shared tokens)
        window.getTokenCollectionRef = () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return collection(window.db, `artifacts/${appId}/public/data/tokens`);
        };

        // --- Firebase Initialization and Authentication ---
        window.initFirebase = async () => {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (Object.keys(firebaseConfig).length === 0) {
                    window.showMessage('ERROR: Konfigurasi Firebase hilang!', 'error');
                    return;
                }

                const firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(firebaseApp);
                window.auth = getAuth(firebaseApp);

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                    } else {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(window.auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    }
                    window.isAuthReady = true;
                    window.renderView();
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                window.showMessage(`ERROR: Gagal inisialisasi Firebase: ${error.message}`, 'error');
            }
        };

        // --- CORE USER FUNCTIONS (Token Validation) ---

        /** Validates user token against Firestore */
        window.validateToken = async () => {
            const token = document.getElementById('tokenInput').value.trim().toUpperCase();
            if (!token) {
                window.showMessage('Masukkan token akses Anda.', 'info');
                return;
            }

            window.showLoading('Memvalidasi Kredensial di Jaringan Inti...');

            try {
                const tokenRef = window.getTokenCollectionRef();
                const q = query(tokenRef, where("token", "==", token));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    window.showMessage('Token tidak ditemukan. Kredensial tidak valid.', 'error');
                    return;
                }

                const tokenDoc = querySnapshot.docs[0];
                const data = tokenDoc.data();
                
                if (data.usageCount >= data.usageLimit) {
                    window.showMessage('Token ini telah habis masa pakai (Slot Penuh).', 'error');
                    return;
                }
                
                window.userTokenData = { ...data, id: tokenDoc.id }; 

                window.hideLoading();
                window.renderView('scriptDashboardView'); 

            } catch (e) {
                window.hideLoading();
                console.error("Validation error:", e);
                window.showMessage('Token tidak valid atau terjadi kesalahan jaringan.', 'error');
            }
        };


        // --- ADMIN FUNCTIONS ---

        /** Copies the text to the clipboard */
        window.copyToClipboard = (text, displayId) => {
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            const displayElement = document.getElementById(displayId);
            if (displayElement) {
                const originalText = displayElement.textContent;
                displayElement.textContent = 'BERHASIL DISALIN! (CORE CHECK)';
                displayElement.classList.add('text-secondary-accent');
                
                setTimeout(() => {
                    displayElement.textContent = originalText;
                    displayElement.classList.remove('text-secondary-accent');
                }, 2000);
            }
        };

        /** Checks the admin key and redirects to the admin panel if correct. */
        window.checkAdminKey = () => {
            const key = document.getElementById('adminKeyInput').value.trim();
            if (key === ADMIN_KEY) {
                window.showMessage('Akses Admin Diberikan.', 'success', () => {
                    window.renderView('adminPanelview');
                });
            } else {
                window.showMessage('Kunci Admin Salah. Akses Ditolak.', 'error');
            }
        };

        /** Generates a random alphanumeric token string (e.g., X-X-X-X). */
        function generateTokenString() {
            const segment = () => Math.random().toString(36).substring(2, 6).toUpperCase();
            return `${segment()}-${segment()}-${segment()}-${segment()}`;
        }

        /** Creates a new token document in Firestore. */
        window.createToken = async () => {
            const scriptId = document.getElementById('scriptSelect').value;
            const usageLimit = parseInt(document.getElementById('usageLimitInput').value.trim(), 10);
            
            if (scriptId === 'default') {
                window.showMessage('Pilih ID Script yang valid.', 'info');
                return;
            }

            if (isNaN(usageLimit) || usageLimit < 1) {
                window.showMessage('Batas Penggunaan (Slot) harus diisi dengan angka positif.', 'info');
                return;
            }

            window.showLoading('Menciptakan Kredensial Akses Baru...');
            const newToken = generateTokenString();

            try {
                await addDoc(window.getTokenCollectionRef(), {
                    token: newToken,
                    scriptId: scriptId, // Storing the Script ID (e.g., 'base')
                    usageLimit: usageLimit,
                    usageCount: 0,
                    createdAt: new Date().toISOString(),
                    createdBy: window.userId,
                });

                window.hideLoading();
                
                // RENDER token display with COPY BUTTON
                document.getElementById('createdTokenDisplay').innerHTML = `
                    <p class="text-xl font-mono text-secondary-accent break-all p-4 bg-core-dark/50 border border-secondary-accent/50 rounded-lg shadow-inner">${newToken}</p>
                    <div class="flex justify-between items-center mt-3">
                        <p id="copyStatusText" class="text-sm text-gray-500 transition-colors">Token berhasil dibuat untuk: 
                           <span class="text-primary-accent">${window.getScriptDetails(scriptId).name}</span></p>
                        <button onclick="window.copyToClipboard('${newToken}', 'copyStatusText')" 
                                class="accent-btn !py-2 !px-4 !text-sm !font-semibold transition duration-200 !bg-secondary-accent !text-core-dark">
                            <span data-lucide="copy" class="inline-block w-4 h-4 mr-1"></span> SALIN
                        </button>
                    </div>
                `;

                document.getElementById('usageLimitInput').value = '1';
                window.fetchAdminTokens(); 
                window.showMessage(`Token ${newToken} Berhasil Dibuat!`, 'success');

            } catch (error) {
                window.hideLoading();
                console.error("Error creating token:", error);
                window.showMessage(`ERROR: Gagal membuat token: ${error.message}`, 'error');
            }
        };
        
        /** Fetches all tokens for the admin view. */
        window.fetchAdminTokens = async () => {
            window.showLoading('Mengambil Daftar Token dari Database Core...');
            try {
                const tokenRef = window.getTokenCollectionRef();
                const snapshot = await getDocs(query(tokenRef)); 
                
                let tokens = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                }));
                
                tokens.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());

                window.hideLoading();
                window.renderTokenTable(tokens);
            } catch (error) {
                window.hideLoading();
                console.error("Error fetching tokens:", error);
                window.showMessage(`ERROR: Gagal mengambil token: ${error.message}`, 'error');
            }
        };

        /** Renders the token list table in the admin panel. */
        window.renderTokenTable = (tokens) => {
            const tableContainer = document.getElementById('tokenListContainer');
            if (!tableContainer) return;

            let html = `
                <div class="overflow-x-auto rounded-xl shadow-depth">
                    <table class="min-w-full divide-y divide-primary-accent/20">
                        <thead>
                            <tr class="text-xs text-primary-accent uppercase tracking-widest bg-core-dark/70 sticky top-0">
                                <th class="p-4 text-left">Token (Snippet)</th>
                                <th class="p-4 text-left">Target Script</th>
                                <th class="p-4 text-center">Batas/Sisa</th>
                                <th class="p-4 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-primary-accent/10">
            `;

            if (tokens.length === 0) {
                html += `
                    <tr>
                        <td colspan="4" class="p-4 text-center text-gray-700">Tidak ada token yang ditemukan.</td>
                    </tr>
                `;
            } else {
                tokens.forEach(token => {
                    const remaining = (token.usageLimit || 0) - (token.usageCount || 0);
                    const isExpired = remaining <= 0;
                    const statusText = isExpired ? 'HABIS' : 'AKTIF';
                    const statusColor = isExpired ? 'text-error-red' : 'text-secondary-accent';
                    const usageDisplay = `${token.usageCount || 0}/${token.usageLimit || 0}`;
                    
                    const scriptDetail = window.getScriptDetails(token.scriptId);
                    
                    html += `
                        <tr class="hover:bg-glass-bg/50 transition duration-300">
                            <td class="p-4 text-sm font-mono text-text-light/80">${token.token.substring(0, 4)}...${token.token.slice(-4)}</td>
                            <td class="p-4 text-sm text-primary-accent/90 font-semibold">${scriptDetail.name}</td>
                            <td class="p-4 text-sm text-center font-bold text-text-light">${usageDisplay}</td>
                            <td class="p-4 text-center text-sm ${statusColor} font-semibold">${statusText}</td>
                        </tr>
                    `;
                });
            }

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            tableContainer.innerHTML = html;
        };


        // --- UI Helper Functions & RENDER LOGIC ---

        window.showLoading = (message = 'Memuat Data Jaringan...') => {
            const loadingScreen = document.getElementById('loadingScreen');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = message;
            loadingScreen.style.display = 'flex';
            setTimeout(() => { loadingScreen.style.opacity = 1; }, 10);
        };

        window.hideLoading = () => {
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.style.opacity = 0;
            setTimeout(() => { 
                loadingScreen.style.display = 'none'; 
                document.getElementById('popupOverlay').classList.add('hidden');
            }, 500); 
        };

        /** Popups must be dismissed manually by user click. */
        window.showMessage = (message, type = 'info', callback = null) => {
            const popup = document.getElementById('interactivePopup');
            const icon = document.getElementById('popupIcon');
            const messageEl = document.getElementById('popupMessage');
            const overlay = document.getElementById('popupOverlay');

            let iconClass = '';
            let colorClass = '';
            let title = '';

            switch (type) {
                case 'success':
                    iconClass = 'lucide-check-circle';
                    colorClass = 'text-secondary-accent';
                    title = 'Akses Diberikan';
                    break;
                case 'error':
                    iconClass = 'lucide-x-octagon';
                    colorClass = 'text-error-red';
                    title = 'Akses Ditolak';
                    break;
                case 'info':
                default:
                    iconClass = 'lucide-info';
                    colorClass = 'text-primary-accent';
                    title = 'Pemberitahuan Sistem';
                    break;
            }
            
            icon.setAttribute('class', `w-16 h-16 mb-4 mx-auto ${colorClass} animate-pulse`);
            icon.setAttribute('data-lucide', iconClass);
            messageEl.textContent = message;
            document.getElementById('popupTitle').textContent = title;

            lucide.createIcons();

            overlay.classList.remove('hidden');
            popup.classList.add('scale-100', 'opacity-100');
            popup.classList.remove('scale-90', 'opacity-0'); 

            const dismissPopup = () => {
                popup.classList.remove('scale-100', 'opacity-100');
                popup.classList.add('scale-90', 'opacity-0');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    if (callback) callback();
                }, 300);
            };

            document.getElementById('popupDismissBtn').textContent = 'TUTUP (CORE CHECK)';
            document.getElementById('popupDismissBtn').classList.toggle('!bg-error-red', type === 'error');
            document.getElementById('popupDismissBtn').classList.toggle('accent-btn', type !== 'error');
            document.getElementById('popupDismissBtn').onclick = dismissPopup;
        };


        window.renderView = (viewName = window.currentView) => {
            if (!window.isAuthReady) {
                document.getElementById('mainContent').innerHTML = `
                    <div class="text-center p-8">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-primary-accent animate-data-stream font-mono">Mengautentikasi Sesi Quantum...</p>
                    </div>
                `;
                return;
            }

            window.currentView = viewName;
            const mainContent = document.getElementById('mainContent');
            
            mainContent.className = 'glass-container shadow-2xl w-full';
            mainContent.innerHTML = ''; 

            switch (viewName) {
                case 'landingView':
                    mainContent.innerHTML = landingView();
                    break;
                case 'tokenInputView':
                    mainContent.innerHTML = tokenInputView();
                    break;
                case 'scriptDashboardView':
                    mainContent.innerHTML = scriptDashboardView();
                    break;
                case 'adminLoginView':
                    mainContent.innerHTML = adminLoginView();
                    break;
                case 'adminPanelview':
                    mainContent.innerHTML = adminPanelview();
                    // Populate and fetch data after view is rendered
                    const select = document.getElementById('scriptSelect');
                    if(select) {
                        SCRIPT_MAP.forEach(script => {
                            const option = document.createElement('option');
                            option.value = script.id;
                            option.textContent = `${script.name} (${script.id})`;
                            select.appendChild(option);
                        });
                    }
                    setTimeout(window.fetchAdminTokens, 100); 
                    break;
                case 'thankYouView':
                    mainContent.innerHTML = thankYouView();
                    break;
                default:
                    mainContent.innerHTML = landingView();
            }
            lucide.createIcons(); 
        };
        
        // --- VIEW TEMPLATES ---

        const landingView = () => `
            <div class="p-10 md:p-20 text-center">
                <h1 class="text-6xl md:text-8xl font-extrabold mb-4 text-primary-accent drop-shadow-lg [text-shadow:_0_0_5px_#4F46E5]">
                    GenshiroBot Script
                </h1>
                <h2 class="text-2xl md:text-4xl font-light mb-10 text-text-light/80 font-mono">
                    Akses Download Script
                </h2>
                <p class="text-lg md:text-xl text-gray-400 mb-10 max-w-lg mx-auto">
                    Token berbatas diperlukan untuk otorisasi unduhan skrip inti.
                </p>
                <button onclick="window.renderView('tokenInputView')" class="accent-btn text-xl w-full mb-4 max-w-sm mx-auto block">
                    <span data-lucide="shield-plus" class="inline-block mr-3 w-6 h-6"></span>
                    MASUKKAN TOKEN
                </button>
                <p class="text-sm text-gray-600 mt-6 cursor-pointer hover:text-primary-accent transition font-mono" onclick="window.renderView('adminLoginView')">
                    -
                </p>
            </div>
        `;
        
        const adminLoginView = () => `
            <div class="p-10 md:p-20 text-center">
                <h2 class="text-4xl md:text-5xl font-bold mb-8 text-secondary-accent drop-shadow-lg">ماذا تفعل؟</h2>
                <p class="text-gray-400 mb-8 font-mono">تحقق من مفتاح الماستر. أدخل مفتاح المشرف (Core-ID):</p>

                <div class="relative max-w-sm mx-auto">
                    <input type="password" id="adminKeyInput" placeholder="مفتاح الماستر"
                        class="glass-input w-full p-4 text-xl text-text-light placeholder-gray-500 transition rounded-lg"
                        onkeydown="if(event.key === 'Enter') window.checkAdminKey()">
                    <div class="absolute right-4 top-1/2 transform -translate-y-1/2">
                        <span data-lucide="lock" class="w-6 h-6 text-secondary-accent"></span>
                    </div>
                </div>

                <button onclick="window.checkAdminKey()" class="accent-btn mt-8 w-full max-w-sm text-lg !bg-error-red hover:!bg-red-700">
                    <span data-lucide="key-round" class="inline-block mr-2 w-5 h-5"></span>
                    التحقق
                </button>
                <p class="text-xs text-gray-700 mt-8 cursor-pointer hover:text-primary-accent transition font-mono" onclick="window.renderView('landingView')">
                    -
                </p>
            </div>
        `;
        
        /** NEW: Includes a dropdown for script selection */
        const adminPanelview = () => `
            <div class="p-6 md:p-10">
                <h2 class="text-3xl md:text-4xl font-bold mb-8 text-primary-accent text-center drop-shadow-lg font-mono">PANEL KONTROL ${window.userId.substring(0, 8)}...</h2>
                
                <div class="grid lg:grid-cols-2 gap-8">
                    <!-- Token Creation Form -->
                    <div class="glass-container p-6 border-white/10 shadow-depth !rounded-xl">
                        <h3 class="text-xl font-bold mb-5 flex items-center text-secondary-accent">
                            <span data-lucide="wrench" class="w-5 h-5 mr-3"></span> MINT NEW ACCESS TOKEN
                        </h3>
                        
                        <label class="block text-sm font-medium text-gray-400 mb-1 font-mono" for="scriptSelect">Pilih Script Target</label>
                        <select id="scriptSelect" 
                            class="glass-input w-full p-3 text-text-light rounded-lg mb-4 appearance-none pr-8">
                            <option value="default" disabled selected>-- Pilih ID Script --</option>
                            <!-- Options populated by JS init -->
                        </select>
                        
                        <label class="block text-sm font-medium text-gray-400 mb-1 font-mono" for="usageLimitInput">Batas Penggunaan (Slot Download)</label>
                        <input type="number" id="usageLimitInput" value="1" min="1"
                            class="glass-input w-full p-3 text-text-light rounded-lg mb-6">
                        
                        <button onclick="window.createToken()" class="accent-btn w-full text-base !bg-primary-accent hover:!bg-secondary-accent">
                            <span data-lucide="loader" class="inline-block mr-2 w-5 h-5"></span>
                            GENERATE TOKEN
                        </button>

                        <div id="createdTokenDisplay" class="min-h-[50px] mt-6">
                            <p class="text-gray-500 text-sm font-mono">Token baru akan di-mint di sini.</p>
                        </div>
                    </div>

                    <!-- Token List -->
                    <div class="glass-container p-6 border-white/10 shadow-depth !rounded-xl">
                        <h3 class="text-xl font-bold mb-5 flex items-center text-secondary-accent">
                            <span data-lucide="activity" class="w-5 h-5 mr-3"></span> TOKEN STATUS & LOGS
                            <button onclick="window.fetchAdminTokens()" class="ml-auto text-xs text-gray-400 hover:text-primary-accent transition font-mono">
                                <span data-lucide="refresh-cw" class="w-4 h-4 inline-block mr-1"></span> REFRESH
                            </button>
                        </h3>
                        <div id="tokenListContainer" class="max-h-96 overflow-y-auto">
                            <div class="text-center p-4">
                                <div class="spinner w-8 h-8 mx-auto mb-2"></div>
                                <p class="text-sm text-gray-500 font-mono">MEMUAT LOGS...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <p class="text-xs text-gray-700 mt-10 text-center cursor-pointer hover:text-primary-accent transition font-mono" onclick="window.renderView('landingView')">
                    << LOGOUT_ADMIN_SESSION
                </p>
            </div>
        `;


        const tokenInputView = () => `
            <div class="p-10 md:p-20 text-center">
                <h2 class="text-4xl md:text-5xl font-bold mb-6 text-primary-accent drop-shadow-lg font-mono">INPUT KREDENSIAL</h2>
                <p class="text-gray-400 mb-8 max-w-md mx-auto">Token Access Kriptografi Core-V6 (16-Digit):</p>

                <div class="relative max-w-md mx-auto">
                    <input type="text" id="tokenInput" placeholder="XXXX-XXXX-XXXX-XXXX"
                        class="glass-input w-full p-4 text-xl font-mono text-text-light placeholder-gray-500 transition rounded-lg"
                        onkeydown="if(event.key === 'Enter') window.validateToken()">
                    <div class="absolute right-4 top-1/2 transform -translate-y-1/2">
                        <span data-lucide="fingerprint" class="w-6 h-6 text-primary-accent"></span>
                    </div>
                </div>

                <button id="tokenValidateBtn" onclick="window.validateToken()" class="accent-btn mt-8 w-full max-w-md text-xl !bg-secondary-accent hover:!bg-primary-accent">
                    <span data-lucide="check-circle" class="inline-block mr-2 w-6 h-6"></span>
                    AKTIFKAN AKSES
                </button>
                <p class="text-xs text-gray-700 mt-8 cursor-pointer hover:text-primary-accent transition font-mono" onclick="window.renderView('landingView')">
                    << CANCEL_OPERATION
                </p>
            </div>
        `;

        /** UPDATED: Dashboard fetches script details using the stored scriptId. */
        const scriptDashboardView = () => {
            if (!window.userTokenData) return `
                <div class="p-8 text-center text-error-red">ERROR: Token data tidak ditemukan. Harap autentikasi ulang.</div>
                <button onclick="window.renderView('tokenInputView')" class="accent-btn mt-4">Coba Lagi</button>
            `;

            const { scriptId, usageCount, usageLimit, id: docId } = window.userTokenData;
            
            // Look up the full details using the scriptId
            const scriptDetails = window.getScriptDetails(scriptId);
            const downloadUrl = scriptDetails.url;
            const scriptName = scriptDetails.name;
            
            const remainingUses = (usageLimit || 0) - (usageCount || 0);
            const progress = ((usageCount || 0) / (usageLimit || 1)) * 100;
            const isExpired = remainingUses <= 0;

            return `
                <div class="p-6 md:p-12">
                    <!-- Header and Status -->
                    <div class="text-center mb-8">
                        <h2 class="text-4xl md:text-6xl font-extrabold text-secondary-accent drop-shadow-lg [text-shadow:_0_0_5px_#10B981]">${scriptName}</h2>
                        <p class="text-gray-400 mt-2 text-2xl font-mono">TOKEN VALID: SUCCES ACCESS</p>
                        <div class="mt-4 flex justify-center items-center space-x-6">
                            <span class="text-md font-mono text-primary-accent flex items-center">
                                <span data-lucide="activity" class="w-5 h-5 mr-2"></span> JARINGAN CORE: STABIL
                            </span>
                            <span class="text-md font-mono text-text-light flex items-center">
                                <span data-lucide="key-square" class="w-5 h-5 mr-2"></span> SLOT TERPAKAI: ${usageCount}/${usageLimit} (SISA: ${remainingUses})
                            </span>
                        </div>
                    </div>
                    
                    <!-- Progress Bar (Usage) -->
                    <div class="max-w-2xl mx-auto mb-10">
                        <p class="text-sm text-gray-500 mb-1 text-left font-mono">LOAD LEVEL (Progress Penggunaan: ${progress.toFixed(2)}%)</p>
                        <div class="w-full bg-core-dark/50 rounded-full h-4 border border-primary-accent/50">
                            <div class="h-full rounded-full transition-all duration-1000" 
                                style="width: ${progress}%; background-color: ${isExpired ? '#F87171' : '#4F46E5'}; box-shadow: 0 0 8px ${isExpired ? '#F87171' : '#4F46E5'};">
                            </div>
                        </div>
                    </div>

                    <!-- Details and Download -->
                    <div class="glass-container p-8 mb-8 border-white/10 grid md:grid-cols-2 gap-8 !rounded-xl">
                        <div>
                            <h3 class="text-2xl font-bold text-secondary-accent mb-4 flex items-center font-mono"><span data-lucide="cpu" class="w-6 h-6 mr-3"></span> INFORMASI DATA INTI</h3>
                            <p class="text-gray-400 font-mono text-sm">Token ID: <code>${window.userTokenData.token.substring(0, 4)}...</code></p>
                            <p class="text-gray-400 mt-4 font-mono text-sm">Download URL (Snippet):</p>
                            <p class="text-primary-accent text-md font-mono break-all mt-1">
                                ${downloadUrl.substring(0, 40)}...
                            </p>
                            <p class="text-gray-500 text-sm italic mt-4">"Slot ini memberikan satu kali otorisasi unduhan yang valid."</p>
                        </div>
                        
                        <div class="text-center md:text-right flex flex-col justify-between items-center md:items-end">
                            <div class="mb-6">
                                <h3 class="text-3xl font-bold text-primary-accent mb-3 flex items-center justify-end font-mono">
                                    <span data-lucide="cloud-lightning" class="w-7 h-7 mr-2"></span> INITIATE DOWNLOAD
                                </h3>
                                <p class="text-gray-400 text-md font-mono">PERHATIAN: Hanya 1x unduhan!</p>
                            </div>
                            
                            <button ${isExpired ? 'disabled' : ''} onclick="window.handleDownloadAndIncrement('${downloadUrl}', '${docId}', ${usageCount}, ${usageLimit})" 
                                class="accent-btn text-xl p-4 w-full md:w-auto self-end transition-all !bg-secondary-accent hover:!bg-primary-accent ${isExpired ? 'opacity-50 cursor-not-allowed !bg-error-red/50 !shadow-none' : ''}">
                                <span data-lucide="arrow-down-to-line" class="inline-block mr-2 w-6 h-6"></span>
                                UNDUH & KUNCI SLOT
                            </button>
                            ${isExpired ? 
                                `<p class="text-sm text-error-red mt-2 font-mono">SLOT EXPIRED: AKSES DIKUNCI</p>` : 
                                `<p class="text-xs text-gray-700 mt-2 font-mono">AKAN MENGHITUNG SEBAGAI PENGGUNAAN KE-${(usageCount || 0) + 1}</p>`
                            }
                        </div>
                    </div>

                    <p class="text-xs text-gray-700 mt-8 text-center cursor-pointer hover:text-primary-accent transition font-mono" onclick="window.renderView('landingView')">
                        << END_SESSION
                    </p>
                </div>
            `;
        };
        
        /** NEW FUNCTION: Handles the download, then increments the usage count in Firestore. */
        window.handleDownloadAndIncrement = async (downloadUrl, docId, currentCount, limit) => {
            if ((currentCount || 0) >= (limit || 0)) {
                window.showMessage('Token ini telah habis masa pakainya.', 'error');
                return;
            }

            if (window.hasDownloaded) {
                 window.showMessage('Anda sudah melakukan unduhan. Harap tutup sesi.', 'info', () => {
                    window.renderView('thankYouView');
                 });
                 return;
            }

            // 1. Open Download Link immediately
            window.open(downloadUrl, '_blank');
            window.hasDownloaded = true; 

            window.showLoading('MENGUNCI SLOT AKSES... MENGUPDATE DATABASE CORE...');

            try {
                // 2. Increment usage count in a transaction
                const docRef = doc(window.getTokenCollectionRef(), docId);
                
                await runTransaction(window.db, async (transaction) => {
                    const freshDoc = await transaction.get(docRef);
                    const data = freshDoc.data();
                    
                    if ((data.usageCount || 0) >= (data.usageLimit || 0)) {
                         throw new Error("Token already exhausted in concurrent transaction.");
                    }

                    const newUsageCount = (data.usageCount || 0) + 1;
                    transaction.update(docRef, { usageCount: newUsageCount });
                    window.userTokenData.usageCount = newUsageCount; // Update local state
                });


                window.hideLoading();
                window.showMessage('TRANSFER DATA SELESAI & SLOT DIKUNCI!', 'success', () => {
                    window.renderView('thankYouView');
                });

            } catch(e) {
                window.hideLoading();
                console.error("Error during increment transaction:", e);
                window.showMessage('ERROR KRITIS: Unduhan berhasil, tetapi slot gagal dikunci. Harap hubungi Admin.', 'error');
                window.renderView('thankYouView');
            }
        };


        const thankYouView = () => `
            <div class="p-10 md:p-20 text-center">
                <span data-lucide="zap" class="w-20 h-20 mx-auto text-secondary-accent mb-6 animate-pulse"></span>
                <h2 class="text-5xl md:text-6xl font-extrabold mb-4 text-primary-accent [text-shadow:_0_0_5px_#4F46E5]">
                    SINKRONISASI SELESAI
                </h2>
                <p class="text-lg md:text-xl text-gray-300 mb-8 max-w-lg mx-auto font-mono">
                    Integritas data diverifikasi. Koneksi Core diakhiri.
                </p>
                <div class="glass-container p-6 max-w-sm mx-auto border-white/10 shadow-depth !rounded-xl">
                    <p class="text-md text-gray-200 mb-4 font-mono">
                        STATUS PENGGUNAAN AKHIR: ${window.userTokenData ? window.userTokenData.usageCount + '/' + window.userTokenData.usageLimit : 'N/A'}
                    </p>
                    <button onclick="window.renderView('landingView')" class="accent-btn text-md p-3 w-full !bg-secondary-accent !text-core-dark">
                        <span data-lucide="monitor-check" class="inline-block mr-2 w-5 h-5"></span>
                        TUTUP TERMINAL
                    </button>
                </div>
            </div>
        `;


        // --- Three.js 3D Animation Logic (Deep Core Grid) ---
        let scene, camera, renderer, clock, plane, particles;
        const PARTICLE_COUNT = 1500;
        
        window.initThreeJs = function() {
            const canvas = document.getElementById('threeCanvas');
            if (!canvas) return;
            
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x060B12, 1); 
            renderer.outputEncoding = THREE.sRGBEncoding;

            scene = new THREE.Scene();
            clock = new THREE.Clock();

            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 25, 50); 
            camera.rotation.x = -Math.PI / 8; // Gentler angle
            
            // Deep fog to enhance depth
            scene.fog = new THREE.Fog(0x060B12, 1, 100); 

            // 1. DYNAMIC GRID (Subtle Wave)
            const segments = 100; 
            const areaSize = 300; 
            
            const geometry = new THREE.PlaneGeometry(areaSize, areaSize, segments, segments);
            const material = new THREE.MeshBasicMaterial({
                color: 0x4F46E5, // Primary Accent color
                wireframe: true, 
                transparent: true,
                opacity: 0.2, // Very subtle grid
                blending: THREE.AdditiveBlending // Still uses additive blending for smoothness
            });

            plane = new THREE.Mesh(geometry, material);
            plane.rotation.x = -Math.PI / 2; 
            plane.position.y = 0;
            plane.position.z = -150; 
            plane.userData.initialPositions = geometry.attributes.position.array.slice(0); 
            scene.add(plane);
            
            // 2. PARTICLE STARFIELD (Less intense, deeper colors)
            const pGeometry = new THREE.BufferGeometry();
            const pPositions = new Float32Array(PARTICLE_COUNT * 3);
            const pColors = new Float32Array(PARTICLE_COUNT * 3);
            const color = new THREE.Color();
            
            for (let i = 0; i < PARTICLE_COUNT * 3; i += 3) {
                pPositions[i] = (Math.random() - 0.5) * 500;
                pPositions[i + 1] = Math.random() * 50; 
                pPositions[i + 2] = (Math.random() - 0.5) * 500;

                // Color: Deep white to subtle Indigo
                color.setHSL(0.65 + Math.random() * 0.1, 0.5, 0.8); 
                pColors[i] = color.r;
                pColors[i + 1] = color.g;
                pColors[i + 2] = color.b;
            }

            pGeometry.setAttribute('position', new THREE.BufferAttribute(pPositions, 3));
            pGeometry.setAttribute('color', new THREE.BufferAttribute(pColors, 3));
            
            const pMaterial = new THREE.PointsMaterial({
                size: 0.3, // Smaller size for smoothness
                vertexColors: true,
                blending: THREE.AdditiveBlending,
                transparent: true,
                opacity: 0.5
            });

            particles = new THREE.Points(pGeometry, pMaterial);
            scene.add(particles);

            window.addEventListener('resize', onWindowResize, false);
            window.animate(); 
        }

        window.animate = function() {
            requestAnimationFrame(window.animate); 

            const delta = clock.getDelta();
            const elapsed = clock.getElapsedTime();
            if (!plane || !particles) return; 

            // Grid Wave Distortion (Smoother, smaller amplitude)
            const positions = plane.geometry.attributes.position.array;
            const initialPositions = plane.userData.initialPositions;
            const frequency = 0.005; 
            const amplitude = 3; 

            for (let i = 0; i < positions.length / 3; i++) {
                const x = initialPositions[i * 3 + 0]; 
                const y = initialPositions[i * 3 + 1]; 
                
                positions[i * 3 + 2] = initialPositions[i * 3 + 2] + 
                                       amplitude * Math.sin((x * frequency) + elapsed * 1.5) * Math.cos((y * frequency) + elapsed * 1.0);
            }
            plane.geometry.attributes.position.needsUpdate = true;
            
            // Grid Continuous Movement (Slow scroll)
            plane.position.z += 10 * delta; 
            if (plane.position.z > 50) {
                plane.position.z = -250; 
            }
            
            // Particle Movement (Slow, heavy flow)
            const pPositions = particles.geometry.attributes.position.array;
            for (let i = 2; i < PARTICLE_COUNT * 3; i += 3) {
                pPositions[i] += 20 * delta; 
                if (pPositions[i] > 100) {
                    pPositions[i] -= 500; 
                }
            }
            particles.geometry.attributes.position.needsUpdate = true;
            
            // Camera subtle sway
            camera.position.x = Math.sin(elapsed * 0.03) * 3; 
            camera.position.y = 25 + Math.cos(elapsed * 0.03) * 1; 
            camera.rotation.z = Math.sin(elapsed * 0.02) * 0.02; 

            if (renderer) {
                renderer.render(scene, camera);
            }
        }

        function onWindowResize() {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            window.initFirebase();
            window.initThreeJs();
        });
    </script>
</head>
<body class="bg-core-dark">

    <!-- 3D Full-Screen Canvas Backdrop -->
    <canvas id="threeCanvas"></canvas>

    <!-- Interactive Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-core-dark/95 hidden z-40 flex items-center justify-center transition-opacity duration-500 opacity-0">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p id="loadingText" class="text-xl font-semibold text-primary-accent animate-pulse font-mono"></p>
        </div>
    </div>

    <!-- Interactive Popup/Modal (MANUAL DISMISSAL REQUIRED) -->
    <div id="popupOverlay" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center transition-opacity duration-300 backdrop-blur-md">
        <div id="interactivePopup" class="glass-container p-8 max-w-sm text-center transform scale-90 opacity-0 transition-all duration-500 ease-smooth-curve border-primary-accent/50 shadow-depth">
            <!-- Icon is an SVG created by Lucide, handled by JS -->
            <div id="popupIcon" data-lucide="info"></div>
            <h3 id="popupTitle" class="text-3xl font-bold mb-3 text-white font-mono">Pemberitahuan Sistem</h3>
            <p id="popupMessage" class="text-gray-300 mb-6 font-mono"></p>
            <button id="popupDismissBtn" class="accent-btn text-md p-3 !text-lg !bg-secondary-accent !text-core-dark"></button>
        </div>
    </div>

    <!-- Main Content Container -->
    <div id="mainContent" class="glass-container shadow-2xl w-full max-w-5xl">
        <!-- Content will be injected here by renderView() -->
        <div class="text-center p-12">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-primary-accent animate-data-stream font-mono">MEMUAT SISTEM...</p>
        </div>
    </div>

<script type="module" src="script.js"></script>.

</body>
</html>
